var flask = {

    content: [],

    dummyContent: [{"type":"tweet","author":"tylermensah","content":"Anyone who takes longs than 3 minutes to reply i instantly think i'm annoying them.."},{"type":"tweet","author":"SexySpittie","content":"http://t.co/DrOZ7c4gym"},{"type":"tweet","author":"SexySpittie","content":"http://t.co/i7QA7sFZZU"},{"type":"tweet","author":"JemmaBaker8","content":"@Cammersss http://t.co/7Drmwc13kp"},{"type":"tweet","author":"SexySpittie","content":"http://t.co/H8CndY6c2v"},{"type":"tweet","author":"SexySpittie","content":"http://t.co/Xcka5OMXCN"},{"type":"tweet","author":"_GisselleRamos","content":"¬øQu√© nos pas√≥? antes nos cont√°bamos de todo y nos ten√≠amos una inmensa confianza."},{"type":"tweet","author":"SexySpittie","content":"http://t.co/4auGM2gpEd"},{"type":"tweet","author":"KennyVersos","content":"Me ignora por 1 dia que eu te ignoro por 1 m√™s, sou assim n√£o sei brincar."},{"type":"tweet","author":"JemmaBaker8","content":"Omg anybody remember the word 'Bashment' hahahhaaaaa"},{"type":"tweet","author":"SexySpittie","content":"http://t.co/38y0h7uLaW"},{"type":"tweet","author":"hcaz96","content":"I wish i had the type of friend i could go to town with and cry on there shoulder."},{"type":"tweet","author":"stuffingballs","content":"it seems I only ever play Lana Del Rey on my speakers these days."},{"type":"tweet","author":"Patri_NLHLZ_1D","content":"@ElChicoFuckYou Vale, te prometo que no habr√° m√°s tweets as√≠."},{"type":"tweet","author":"MissWinkingP","content":"@Laura_Loui5e why yes.....always x"},{"type":"tweet","author":"SexySpittie","content":"\"@Brazzers: What would you name your Dick?\" Mr T"},{"type":"tweet","author":"ThomasPrice182","content":"@TDP182_Official Sounds stupid but hopefully we get hammered then Rafa gets the sack, so we can be back to the best again :-)"},{"type":"tweet","author":"_s5am","content":"Tem uma pessoas, que juro que tento descobrir de onde achou meu facebook"},{"type":"tweet","author":"GeorginaLouiseW","content":"@dangerousDdave bit gonna lie that means nothing to me lol üôà I just meant  drug land central is prob not the place for a mosque lol"},{"type":"tweet","author":"Indzsyo","content":"She should be grateful I even know her"},{"type":"tweet","author":"april_jo1","content":"Mama best be good!"},{"type":"tweet","author":"SexySpittie","content":"I'm done"},{"type":"tweet","author":"Johnpaullll","content":"@laurenbaxter_ @GazGShore I didn't get to see it he deleted it :( what was it haha?"},{"type":"tweet","author":"tuxedo_marx","content":"@Derginet also impressive: http://t.co/gWDvvbyeNY"},{"type":"tweet","author":"ourqueenrauhl","content":"je meurs ."},{"type":"tweet","author":"_GisselleRamos","content":"Gracias a un experimento, me quem√© mi dedo √≠ndice ‚òπ."},{"type":"tweet","author":"LoveeforPyP1D","content":"Holaaaa! &lt;3"},{"type":"tweet","author":"ThomasPrice182","content":"@TDP182_Official would be the best thing ever, although I don't think it would happen :-/ ;-("},{"type":"tweet","author":"_GisselleRamos","content":"‚úÑ."},{"type":"tweet","author":"ourqueenrauhl","content":"@DieusteenBieber cadre ?"},{"type":"tweet","author":"StephenEngel","content":"@CornwallStadium Thanks for the follow. You have some of the best supporters in #rugby !!!"},{"type":"tweet","author":"ThomasPrice182","content":"@TDP182_Official we can all hope though! üëè"},{"type":"tweet","author":"hollywaltersx","content":"@Rii_XX omg who now?!?!"},{"type":"tweet","author":"tuxedo_marx","content":"@Derginet every photo on this page is great"},{"type":"tweet","author":"hollywaltersx","content":"@KatanaV_ @fayeenorman swarm love the horse banter."},{"type":"tweet","author":"Patri_NLHLZ_1D","content":"me *-*. http://t.co/7INruHWL8l"},{"type":"tweet","author":"ghostly_bob","content":"http://t.co/xzHsGJ59cs"},{"type":"tweet","author":"lucyy_w","content":"@justinbieber #HannahForBirminghamOLLG Block 11. Row KK. Seat 480"},{"type":"tweet","author":"JuliConesa","content":"Por fin desp de tanto time el Golcito parte para el taller..Ma√±ana!"},{"type":"tweet","author":"_s5am","content":"Vir ser meu marido n√£o quer n√© ... Af http://t.co/oAdJR7uxeo"},{"type":"tweet","author":"ourqueenrauhl","content":"@DieusteenBieber de rien :)"},{"type":"tweet","author":"flower_ll","content":"‰∏∫‰ªÄ‰πàÊÄªÊòØÊííÊ≤°ÂøÖË¶ÅÁöÑÊÖåÔºåËá™Ê¨∫Ê¨∫‰∫∫ÁúüÁöÑÂ•Ω‰πàÔºå‰∏çÊáÇÔºå‰πü‰∏çÊÉ≥ÊáÇ"},{"type":"tweet","author":"_LouiseEB","content":"@laurenfarrar94 Screw placement... lets go to the Ocean."},{"type":"tweet","author":"SexySpittie","content":"You guys are lucky. Those pics where on my Droid only."},{"type":"tweet","author":"LuuuOfficial","content":"#FechasInolvidables cuando nacio One Direction &lt;3"},{"type":"tweet","author":"_GisselleRamos","content":"@NiallOfficial niaaaaaaaaaaaaaall ‚ò∫‚ô•"},{"type":"photo","author":"stevenfeven","content":"/img/photos/d971943c811511e28ce622000a9f13a7_7.jpg"},{"type":"photo","author":"flasktest","content":"/img/photos/1746cd58811711e290cd22000a1f90d7_7.jpg"},{"type":"photo","author":"holster_x","content":"/img/photos/ed0a5474811611e2aeb222000a1f9e7e_7.jpg"},{"type":"photo","author":"niamh247","content":"/img/photos/15fdd3ba811711e2be6b22000aa80214_7.jpg"},{"type":"photo","author":"benashman","content":"/img/photos/44682b74811711e2ad5822000aaa094d_7.jpg"},{"type":"photo","author":"lindawood1950","content":"/img/photos/86fba894811711e29e6f22000a9e2992_7.jpg"},{"type":"photo","author":"flasktest","content":"/img/photos/97c82c4c811711e2996e22000a1f98fe_7.jpg"},{"type":"photo","author":"lindawood1950","content":"/img/photos/a1258ab4811711e29ee622000aa80004_7.jpg"},{"type":"photo","author":"nazzy1986","content":"/img/photos/a0aa45ac811711e284fa22000a1f9c87_7.jpg"},{"type":"photo","author":"jweekesey","content":"/img/photos/bbd547f0811711e2bfdf22000aa80117_7.jpg"},{"type":"photo","author":"lindawood1950","content":"/img/photos/bbd59912811711e2917a22000a9f1587_7.jpg"},{"type":"photo","author":"tiffkent97","content":"/img/photos/bc62867e811711e299e022000a1fb043_7.jpg"},{"type":"photo","author":"charliechapplex","content":"/img/photos/b9200aae811711e2aacd22000a1f932c_7.jpg"},{"type":"photo","author":"kickassfairy","content":"/img/photos/c56e4532811711e281d822000a1f9682_7.jpg"},{"type":"photo","author":"hywelwynne","content":"/img/photos/d1be62c2811711e2829822000a9f1487_7.jpg"},{"type":"photo","author":"flasktest","content":"/img/photos/e3ef6554811711e2967b22000aa80146_7.jpg"},{"type":"photo","author":"jweekesey","content":"/img/photos/f0edf07c811711e2b46022000a1fb37a_7.jpg"}],

    cork: false,

    pouring: false,

    ledCount: 0,

    updateCount: 0,

    ledIncrement: 2,

    init: function () {

        this.bindMediatorEvents();

        this.drip();

        return this;

    },

    bindMediatorEvents: function () {

        var self = this;

        mediator.subscribe("content:update", function (data, channel) {

            if (self.cork === false && self.ledCount < 32 && self.pouring === false) {

                self.content.push(data);

                console.log("Content added: ", self.content.length);

                self.updateCount++;

                if (self.updateCount === self.ledIncrement) {

                    self.updateCount = 0;

                    self.ledCount++;

                    console.log("ledCount: ", self.ledCount);

                    mediator.publish("fluid:update", self.ledCount);

                }

                mediator.publish("websocket:broadcast", {

                    topic: channel.namespace,

                    payload: data

                });

            }

        });

        mediator.subscribe("flow:update", function (data, channel) {

            if (self.cork === false) {

                if (data > 0) {

                    self.pouring = true;

                } else {

                    self.pouring = false;

                }

                mediator.publish("websocket:broadcast", {

                    topic: channel.namespace,

                    payload: data

                });

            }

        });

        mediator.subscribe("cork:update", function (data) {

            if (data === "0") {

                self.cork = false;

                self.drip();

            } else {

                self.cork = true;

                clearTimeout(self.dripTimeout);

            }

            console.log("Cork set: ", data);

        });

        mediator.subscribe("content:consumed", function () {

            if (self.cork === false && self.ledCount >= 0) {

                self.content.shift();

                self.updateCount--;

                if (self.updateCount < 0) {

                    self.updateCount = self.ledIncrement - 1;

                    self.ledCount--;

                    console.log("ledCount: ", self.ledCount);

                    mediator.publish("fluid:update", self.ledCount);

                }

            }

        });

        mediator.subscribe("websocket:joined", function () {

            mediator.publish("websocket:broadcast", {

                topic: "content:archive",

                payload: self.content

            });

        });

    },

    drip: function () {

        var self = this,
            duration = this.getRandomNumber(100, 5000),
            timeout,
            contentIndex;

        if (self.dummyContent.length) {

            contentIndex = this.getRandomNumber(0, self.dummyContent.length);

            self.dripTimeout = setTimeout(function () {

                mediator.publish("content:update", self.dummyContent.splice(contentIndex, 1)[0]);

                if (self.dummyContent.length) {

                    self.drip();

                }

            }, duration);

        }

    },

    getRandomNumber: function (min, max) {

        return Math.random() * (max - min) + min;

    }

};

module.exports = flask;